#!/bin/bash

GREEN="\033[1;32m"
BLUE="\033[1;36m"
NOCOLOR="\033[0m"
RED="\033[1;31m"

DESTDIR=${DESTDIR:-/usr/local}

QUIT=false
USER="$(whoami)"

echo -ne "${GREEN}Aletheia `cat aletheia | grep \"VERSION=\" | cut -d'\"' -f2`\n\n"
echo -ne "${BLUE}Checking for dependencies...\n\n"

check_dep() {
	local dependency_name="$1"

	echo -ne "${NOCOLOR}checking for $dependency_name... "

	if [ "$(which "$dependency_name" 2>/dev/null)" == "" ]; then
		echo -e "${RED}no"
		QUIT=true
	else
		echo -e "${GREEN}yes"
	fi
}

check_dep pactl
check_dep calc
check_dep bc
check_dep gtts-cli
check_dep play
check_dep espeak-ng
check_dep sox
check_dep ffprobe
check_dep ffmpeg
check_dep iconv
check_dep mplayer
check_dep parallel
check_dep sqlite3
check_dep inotifywait

if [ "$QUIT" == true ]; then
	echo -ne "\n${RED}Error: Unresolved dependencies$NOCOLOR\n"
	exit 1
fi

if [ ! -w "$DESTDIR" ]; then
	echo -e "\n${RED}Error:$NOCOLOR Need root permission to install in $DESTDIR"
	exit 1
fi

mkdir -p "$DESTDIR/bin/"
mkdir -p "$DESTDIR/share/man/man1/"

install -m 755 aletheia "$DESTDIR/bin/"
install -m 644 aletheia.1 "$DESTDIR/share/man/man1/"

chown "$USER:$USER" "$DESTDIR/bin/aletheia"
chown "$USER:$USER" "$DESTDIR/share/man/man1/aletheia.1"

mandb >/dev/null 2>/dev/null

echo -e "\n${GREEN}Aletheia successfully installed in:$NOCOLOR\n"
echo "${DESTDIR}/bin/aletheia"
echo -e "${DESTDIR}/share/man/man1/aletheia.1\n"

if [ "$DESTDIR" != "/usr/local" ] && [ "$DESTDIR" != "/usr/local/" ]; then
	echo -e "${GREEN}Use DESTDIR=${DESTDIR} ./uninstall to remove$NOCOLOR"
else
	echo -e "${GREEN}Use ./uninstall to remove$NOCOLOR"
fi

echo
