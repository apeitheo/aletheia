#!/bin/bash

GREEN="\033[1;32m"
NOCOLOR="\033[0m"
RED="\033[1;31m"

DESTDIR=${DESTDIR:-/usr/local}
if [ "$1" == "--destdir" ]; then
	if [ -d "$2" ]; then
		DESTDIR=$2
	else
		echo -ne "\n${RED}Error: Not a directory$NOCOLOR\n"
		exit 1
	fi
fi

if [ "${1:0:10}" == "--destdir=" ]; then
	dir=${1:10}
	if [ -d "$dir" ]; then
		DESTDIR=$dir
	else
		echo -ne "\n${RED}Error: Not a directory$NOCOLOR\n"
		exit 1
	fi
fi

QUIT=false
USER="$(whoami)"

echo -e "${GREEN}Aletheia $(grep "VERSION=" < aletheia | cut -d'"' -f2)\n"

check_dep() {
	local dependency_name="$1"

	echo -ne "${NOCOLOR}Checking for $dependency_name... "

	if [ "$(which "$dependency_name" 2>/dev/null)" == "" ]; then
		echo -e "${RED}no"
		QUIT=true
	else
		echo -e "${GREEN}yes"
	fi
}

check_dep pactl
check_dep calc
check_dep bc
check_dep gtts-cli
check_dep play
check_dep espeak-ng
check_dep sox
check_dep ffprobe
check_dep ffmpeg
check_dep iconv
check_dep mplayer
check_dep parallel
check_dep sqlite3
check_dep isnum

if [ "$QUIT" == true ]; then
	echo -ne "\n${RED}Error: Unresolved dependencies$NOCOLOR\n"
	exit 1
fi

if [ ! -w "$DESTDIR" ]; then
	echo -e "\n${RED}Error:$NOCOLOR Need root permission to install in $DESTDIR"
	exit 1
fi

echo -ne "\n${NOCOLOR}Installing... $NOCOLOR"

DESTDIR=${DESTDIR%/}
FAIL=false

mkdir -p "$DESTDIR/bin/"
mkdir -p "$DESTDIR/share/man/man1/"
mkdir -p "$DESTDIR/share/applications/"
mkdir -p "$DESTDIR/share/aletheia/themes/"
mkdir -p "$DESTDIR/share/icons/"

if ! install -m 755 aletheia "$DESTDIR/bin/"; then
	FAIL=true
fi
if ! install -m 755 aletheia_desktop_launcher "$DESTDIR/bin/"; then
	FAIL=true
fi
if ! install -m 644 aletheia.1 "$DESTDIR/share/man/man1/"; then
	FAIL=true
fi
if ! install -m 644 aletheia.desktop "$DESTDIR/share/applications/"; then
	FAIL=true
fi
if ! install -m 644 aletheia.png "$DESTDIR/share/icons/"; then
	FAIL=true
fi
if ! install -m 644 ./themes/* "$DESTDIR/share/aletheia/themes/"; then
	FAIL=true
fi

sed -i "/^ALETHEIA_DATA_DIR/s#.*#ALETHEIA_DATA_DIR=\"${DESTDIR}/share/aletheia/\"#g" "$DESTDIR/bin/aletheia"

FILES[0]="${DESTDIR}/bin/aletheia"
FILES[1]="${DESTDIR}/bin/aletheia_desktop_launcher"
FILES[2]="${DESTDIR}/share/man/man1/aletheia.1"
FILES[3]="${DESTDIR}/share/applications/aletheia.desktop"
FILES[4]="${DESTDIR}/share/icons/aletheia.png"
FILES+=("${DESTDIR}/share/aletheia/themes/"*)

for i in $(seq 0 $((${#FILES[@]}-1))); do
	chown "$USER:$USER" "${FILES[i]}"
done

if ! $FAIL; then
	echo -ne "${GREEN}done$NOCOLOR"
	echo -ne "\n\n${NOCOLOR}Updating man pages... $NOCOLOR"
	if ! mandb >/dev/null 2>/dev/null; then
		echo -ne "${RED}failed$NOCOLOR"
	else
		echo -ne "${GREEN}done$NOCOLOR"
	fi

	echo -e "\n"

	for i in $(seq 0 $((${#FILES[@]}-1))); do
		echo "${FILES[i]}"
	done

	if [ "$DESTDIR" != "/usr/local" ] && [ "$DESTDIR" != "/usr/local/" ]; then
		echo -e "\n${NOCOLOR}Use ${GREEN}./uninstall --destdir $DESTDIR$NOCOLOR to remove"
	else
		echo -e "\n${NOCOLOR}Use ${GREEN}./uninstall$NOCOLOR to remove"
	fi
	exit 0
else
	echo -e "${RED}failed$NOCOLOR"
	exit 1
fi
